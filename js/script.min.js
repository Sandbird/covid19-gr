let gData,gRegions=[],gThresholds={carriers:0,deaths:0};const LANG=$("html").attr("lang"),SCROLLBAR_WIDTH=window.innerWidth-$(window).width(),COLORS={default:"#3DC",men:"#5987A5",women:"#86E18D",second:"#FEA",athensopen:"#5987A5",thessopen:"#3BA9B0",deaths:"#FB8",serious:"#FEA",infected_distribution:"#6F6587,#5987A5,#3BA9B0,#48C7A6,#86E18D,#D5F474".split(","),predicted_deaths:"#6F6587,#5987A5,#3BA9B0,#48C7A6,#86E18D,#D5F474".split(","),pcrtests:"#3DC,#5987A5,#3BA9B0,#48C7A6,#86E18D,#D5F474".split(","),dark:"#399",selected:"#EC2"},LABELS={gr:{change:"Τελευταία μεταβολή: ",total:"Σύνολο: ",transition:{carriers:["Κρούσματα"],active:["Ενεργά κρούσματα"],infected_distribution:["Υπό διερεύνηση ή άγνωστης προέλευσης","Σχετιζόμενα με ήδη γνωστό κρούσμα","Σχετιζόμενα με ταξίδι από το εξωτερικό"],predicted_deaths:["χαμηλότερο εύρος","πρόβλεψη","ανώτερο εύρος"],serious:["Κρίσιμη κατάσταση"],deaths:["Θάνατοι"],tests:["Δείγματα που έχουν ελεγχθεί","Κρούσματα"],pcrtests:[""],rt_repro:["Βασικός αναπαραγωγικός αριθμός"],rj_repro:["Αναπαραγωγικός αριθμός"]},unit:{carriers:"",active:"",infected_distribution:"",predicted_deaths:"",serious:"",deaths:"",tests:"",pcrtests:"",rt_repro:"",rj_repro:""},demography:{cases:"Κρούσματα",deaths:"Θάνατοι",serious:"Διασωληνωμένοι"},age:["65+","40-64","18-39","0-17"]},en:{change:"Daily: ",total:"Total: ",transition:{carriers:["Tested Positive"],active:["Active Cases"],infected_distribution:["Still under investigation or of unknown origin","Related to an already known case","Related to travel from abroad"],predicted_deaths:["lower range","projected","upper range"],serious:["Serious"],deaths:["Deaths"],tests:["Tested","Found Positive"],pcrtests:["National Institute of Infectious Diseases","Quarantine Stations","Public Health Institute, Public Health Center","Private Testing Companies","Universities","Medical Institutions"],rj_repro:["Reproduction Number"],rt_repro:["Effective Reproduction Number"]},unit:{carriers:"",active:"",infected_distribution:"",predicted_deaths:"",serious:"",deaths:"",tests:"",pcrtests:"",rt_repro:"",rj_repro:""},demography:{cases:"Cases",deaths:"Deaths",serious:"Serious"},age:["65+","40-64","18-39","0-17"]}},init=()=>{const t=t=>String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),e=()=>{$(".transition.nationwide").each(function(){r($(this),$(this).attr("code"),$(this).attr("pref"),!0),o($(this))})},a=()=>{$(".transition").each(function(){$(this).find(".axis-chart").css("height","calc(100% - "+SCROLLBAR_WIDTH+"px)"),$(this).find(".axis-cover").css("height","calc(100% - "+SCROLLBAR_WIDTH+"px)")})},r=(e,a,r,o=!1)=>{const s=(t,e,a,r,o)=>{let s=COLORS.default,i=n(a,r,!0);return""===e&&"carriers"===t&&(i>=20200328&&(s=COLORS.second),i>=20200601&&(s=COLORS.athensopen),i>=20200615&&(s=COLORS.thessopen),i>=20200701&&(s=COLORS.infected_distribution[o+4]),i>=20200715&&(s=COLORS.infected_distribution[o+5]),i>=20200720&&(s=COLORS.deaths)),"3"===e&&("carriers"!==t&&"deaths"!==t||i>=20200615&&(s=COLORS.athensopen)),"1"===e&&("carriers"!==t&&"deaths"!==t||i>=20200601&&(s=COLORS.athensopen)),""===e&&"infected_distribution"===t&&(s=COLORS.infected_distribution[o]),""===e&&"tests"===t&&(s=COLORS.pcrtests[o]),""===e&&"predicted_deaths"===t&&(s=COLORS.predicted_deaths[o]),""===e&&"pcrtests"===t&&(s=COLORS.pcrtests[o]),"rt_repro"===t&&(s="#242A3C"),s},n=(t,e,a)=>{let r=new Date(t[0],t[1]-1,t[2]);r.setDate(r.getDate()+e);let o="",s=r.getFullYear(),n=r.getMonth()+1,i=r.getDate();if(a){o=1e4*parseInt(s)+100*parseInt(n)+parseInt(i)}else"gr"===LANG&&(o=n+"/"+i),"en"===LANG&&(o=n+"/"+i);return o};const i=(e,a)=>{let r=0,o=0;for(let t=0;t<a.length;t++)for(let e=0;e<a[0].length;e++)r+=a[t][e],t===a.length-1&&(o+=a[t][e]);("rj_repro"===e.attr("code")&&(r=Math.round(100*a[a.length-1][0])/100,o=Math.round(100*(a[a.length-1][0]-a[a.length-2][0]))/100),"rt_repro"===e.attr("code")&&(r=Math.round(100*a[a.length-1][0])/100,o=Math.round(100*(a[a.length-1][0]-a[a.length-2][0]))/100),"predicted_deaths"===e.attr("code"))&&(r=function(t,e){var a=Math.pow(10,e);return Math.round(t*a)/a}(a.reduce(function(t,e){return e.forEach(function(e,a){t[a]=(t[a]||0)+e}),t},[])[1],1),o=Math.round(100*(a[a.length-1][1]-a[a.length-2][1]))/100);var s="";"active"===e.attr("code")&&(s="~"),r=t(r),"-"!==(o=t(o)).charAt(0)&&(o="+"+o);let n=e.find(".latest");n.find(".value").text(s+r),n.find(".unit").text(LABELS[LANG].unit[e.attr("code")]),n.find(".type").text(LABELS[LANG].total),n.find(".change").text(LABELS[LANG].change+o)};let d=e.find(".main-chart").empty().html("<canvas></canvas>"),l=d.find("canvas")[0],c=e.find(".switch.selected").attr("value"),h=!!e.find(".checkbox.moving-average").hasClass("on"),p=gData.transition[a];if(""!==r&&(p=gData["prefectures-data"][parseInt(r)-1][a]),void 0!==p){let g=p.from,f=p.values;i(e,f);var u=!0;"rt_repro"==a&&(u=!1);let b={type:"bar",data:{labels:[],datasets:[]},options:{maintainAspectRatio:!1,animation:{duration:o?1e3:0},legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(t){let a=t[0].xLabel.trim();return"gr"===LANG&&(a="Στις "+a),"en"===LANG&&(a="As of "+a),a+" "+e.find(".switch.selected").text()},label:function(e,r){let o=[],s=0;r.datasets.forEach(function(r,n){if("reproduction_rj_infected"==a){if(root_rj=gData.transition.reproduction_rj.values,!h||n>=1){var i=void 0!==root_rj[e.index]?root_rj[e.index]:"n/a";o.push(r.label+": "+t(r.data[e.index])+" | "+LABELS[LANG].unit[a]+LABELS[LANG].transition.reproduction_rj+": "+i),s+=r.data[e.index]}}else"predicted_deaths"==a?(!h||n>=1)&&o.push(r.label+": "+t(r.data[e.index])+" "+LABELS[LANG].unit[a]):(!h||n>=1)&&(o.push(r.label+": "+t(r.data[e.index])+" "+LABELS[LANG].unit[a]),s+=r.data[e.index])}),o.reverse();let n=h?3:2;return"predicted_deaths"==!a&&r.datasets.length>=n&&o.push(LABELS[LANG].total+": "+t(s)+" "+LABELS[LANG].unit[a]),o}}},scales:{xAxes:[{stacked:!0,gridLines:{display:!1,zeroLineColor:"rgba(255,255,0,0.7)"},ticks:{fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{location:"bottom",stacked:!0,gridLines:{display:!0,zeroLineColor:"rgba(255,255,255,0.7)",borderDash:[3,1],color:"rgba(255, 255, 255, 0.3)"},ticks:{beginAtZero:u,fontColor:"transparent"}}]},layout:{padding:{left:10}}}};for(let t=0;t<f[0].length;t++){if(b.data.datasets.push({label:LABELS[LANG].transition[a][t],backgroundColor:[],data:[]}),"rj_repro"===a){let t=b.data.datasets[b.data.datasets.length-1];t.type="line",t.fill=!1,t.pointRadius=2,t.pointBorderColor="#EC2",t.borderColor="#EC2"}if("rt_repro"===a){let t=b.data.datasets[b.data.datasets.length-1];t.type="line",t.fill=!1,t.pointRadius=2,t.pointBorderColor="#EC2",t.borderColor="#EC2"}if("predicted_deaths"===a){let t=b.data.datasets[b.data.datasets.length-1];"projected"==t.label&&(t.type="line",t.fill=!1,t.pointRadius=2,t.pointBorderColor="#FFA562",t.borderColor="#EC2")}}let L="",C=[];for(let t=0;t<f[0].length;t++)C.push(0);if(f.forEach(function(t,e){let o=s(a,r,g,e,0);b.data.labels.push(n(g,e,!1));for(let o=0;o<f[0].length;o++){C[o]+=t[o];let n=t[o];""===t[o]&&(n=0),n<0&&("total"===c||"carriers"===a||"infected_distribution"===a||"predicted_deaths"===a||"deaths"===a||"tests"===a||"pcrtests"===a)&&(n=0),"total"===c&&(n=C[o]),b.data.datasets[o].data.push(n),b.data.datasets[o].backgroundColor.push(s(a,r,g,e,o))}L=o}),d.width(Math.max(8*b.data.labels.length,d.width())),h){let t=7,e={type:"line",label:LABELS[LANG].movingAverage,fill:!1,borderColor:"#FBA",borderWidth:3,pointRadius:0,data:[]};for(let a=0;a<b.data.datasets[0].data.length;a++){let r=null;if(a>=t){r=0;for(let e=0;e<t;e++)b.data.datasets.forEach(function(t,o){r+=parseInt(t.data[a-e])});r/=t}e.data.push(r)}b.data.datasets.unshift(e)}((t,e)=>{const a=t=>{let e=t.split("/");return e[1]+" "+["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(e[0])-1]};let r=t.find("h5.updated");if(!r.hasClass("show")){let t=e.data.labels[e.data.labels.length-1],o={gr:"Στις "+a(t),en:"As of "+a(t)};r.text(o[LANG]),r.addClass("show")}})(e,b),((e,a,r)=>{let o=e.find(".axis-chart").empty().html("<canvas></canvas>").find("canvas")[0],s={type:"bar",data:a,options:{maintainAspectRatio:!1,legend:{display:!1},title:{display:!1},scales:{xAxes:[{stacked:r,drawBorder:!1,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.0)",maxRotation:0,minRotation:0}}],yAxes:[{id:"axisScale",location:"bottom",stacked:r,gridLines:{drawBorder:!1,display:!1},ticks:{beginAtZero:!0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,r){if(Math.floor(e)===e)return t(e.toString())}}}]}}};s.data.datasets.forEach(function(t,e){t.backgroundColor="transparent",t.borderColor="transparent",t.pointBorderColor="transparent"}),s.data.labels.forEach(function(t,e){}),window.myChart=new Chart(o.getContext("2d"),s);let n=window.myChart.scales.axisScale.max,i=window.myChart.scales.axisScale.min,d=0;switch(Math.max(n.toString().length,i.toString().length)){case 1:d=36;break;case 2:d=40;break;case 3:d=48;break;case 4:d=54;break;case 5:d=66;break;case 6:d=72;break;case 7:d=78}e.find(".axis-cover").width(d.toString()+"px")})(e,$.extend(!0,{},b.data),!0),window.myChart=new Chart(l.getContext("2d"),b)}},o=t=>{let e=t.find(".main-chart");t.find(".main-chart-wrapper").animate({scrollLeft:e.width()},0)},s=t=>{let e=0;return t.forEach(function(t,a){t.forEach(function(t,a){e+=t})}),e},n=e=>{let a=$("#region-chart").empty().html("<canvas></canvas>"),r=a.find("canvas")[0],o=$("#select-pref-type").val(),n={type:"horizontalBar",data:{labels:[],datasets:[{label:"",backgroundColor:[],data:[]}]},options:{aspectRatio:.4,animation:{duration:1e3},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){return gData["prefectures-data"].forEach(function(e,a){e.gr!==t[0].yLabel&&e.en!==t[0].yLabel||$("#select-prefecture").val()!==e.code&&i(e.code)}),t[0].yLabel},label:function(t,e){return t.xLabel+{gr:"",en:" cases"}[LANG]}}},scales:{xAxes:[{position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,r){return t(e)}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};a.outerWidth()>=400&&(n.options.aspectRatio=1.3),""!==e&&(n.options.animation.duration=0);let d=[];gData["prefectures-data"].forEach(function(t,e){d.push({name:gData["prefectures-data"][e][LANG],value:s(t[o].values),code:(e+1).toString()})}),d.sort((t,e)=>t.value<e.value?1:t.value>e.value?-1:0),d.forEach(function(t,a){n.data.labels.push(t.name),n.data.datasets[0].data.push(t.value),e==t.code?n.data.datasets[0].backgroundColor.push(COLORS.selected):n.data.datasets[0].backgroundColor.push((t=>{let e=$("#select-pref-type").val(),a="rgba(90, 90, 90, 0.6)",r=s(gData["prefectures-data"][parseInt(t)-1][e].values);return r>=1&&(a=COLORS.dark,0===gThresholds[e]&&(a=COLORS.default)),r>=gThresholds[e]&&gThresholds[e]>=1&&(a=COLORS.default),a})(t.code))});let l=r.getContext("2d");window.myChart=new Chart(l,n)},i=t=>{$("#select-prefecture").val(t),$(".transition.prefecture").each(function(){$(this).attr("pref",t),$(this).find("h3").find("span").text(gData["prefectures-data"][parseInt(t)-1][LANG]),r($(this),$(this).attr("code"),$(this).attr("pref"),!0),o($(this))})};$.getJSON("https://raw.githubusercontent.com/Sandbird/covid19-Greece/master/greece.json",function(r){gData=r,(()=>{const t=t=>{let e=t.sort((t,e)=>t-e),a=[Math.floor(t.length/2),Math.ceil(t.length/2)];return(e[a[0]]+e[a[1]])/2};for(thType in gThresholds){let e=[];gData["prefectures-data"].forEach(function(t,a){"carriers"!==t[thType]&&"deaths"!==t[thType]||e.push(s(t[thType].values))}),gThresholds[thType]=t(e)}})(),e(),(()=>{$wrapper=$("#demography-chart").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let e={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.cases,backgroundColor:COLORS.default,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.deaths,backgroundColor:COLORS.deaths,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.serious,backgroundColor:COLORS.serious,borderWidth:.5,borderColor:"#242a3c",data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){let e=t[0].yLabel,a=0;return t.forEach(function(t,e){a+=t.xLabel}),e+": "+a+" "+{gr:"",en:"cases"}[LANG]},label:function(t,e){return e.datasets[t.datasetIndex].label+": "+t.value+{gr:"",en:" cases"}[LANG]}}},scales:{xAxes:[{stacked:!0,position:"top",gridLines:{color:"rgba(255,255,255,0.2)",zeroLineColor:"rgba(255,255,255,0.2)",borderDash:[3,1]},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,r){return t(e)}}}],yAxes:[{stacked:!0,barPercentage:.5,gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};$wrapper.outerWidth()>=400&&(e.options.aspectRatio=2.1),$wrapper.outerWidth()>=600&&(e.options.aspectRatio=2.3),gData.demography_sum.forEach(function(t,a){e.data.labels.push(LABELS[LANG].age[a]);for(let a=0;a<3;a++)e.data.datasets[a].data.push(t[a])});let a=$canvas.getContext("2d");window.myChart=new Chart(a,e)})(),(()=>{$wrapper=$("#demography-chart-men").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let e={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.cases,backgroundColor:COLORS.default,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.deaths,backgroundColor:COLORS.deaths,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.serious,backgroundColor:COLORS.serious,borderWidth:.5,borderColor:"#242a3c",data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){let e=t[0].yLabel,a=0;return t.forEach(function(t,e){a+=t.xLabel}),e+": "+a+" "+{gr:"",en:"cases"}[LANG]},label:function(t,e){return e.datasets[t.datasetIndex].label+": "+t.value+{gr:"",en:" cases"}[LANG]}}},scales:{xAxes:[{stacked:!0,position:"top",gridLines:{color:"rgba(255,255,255,0.2)",zeroLineColor:"rgba(255,255,255,0.2)",borderDash:[3,1]},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,r){return t(e)}}}],yAxes:[{stacked:!0,barPercentage:.5,gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};$wrapper.outerWidth()>=400&&(e.options.aspectRatio=2.1),$wrapper.outerWidth()>=600&&(e.options.aspectRatio=2.3),gData.demography_men.forEach(function(t,a){e.data.labels.push(LABELS[LANG].age[a]);for(let a=0;a<3;a++)e.data.datasets[a].data.push(t[a])});let a=$canvas.getContext("2d");window.myChart=new Chart(a,e)})(),(()=>{$wrapper=$("#demography-chart-women").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let e={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.cases,backgroundColor:COLORS.default,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.deaths,backgroundColor:COLORS.deaths,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.serious,backgroundColor:COLORS.serious,borderWidth:.5,borderColor:"#242a3c",data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){let e=t[0].yLabel,a=0;return t.forEach(function(t,e){a+=t.xLabel}),e+": "+a+" "+{gr:"",en:"cases"}[LANG]},label:function(t,e){return e.datasets[t.datasetIndex].label+": "+t.value+{gr:"",en:" cases"}[LANG]}}},scales:{xAxes:[{stacked:!0,position:"top",gridLines:{color:"rgba(255,255,255,0.2)",zeroLineColor:"rgba(255,255,255,0.2)",borderDash:[3,1]},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,r){return t(e)}}}],yAxes:[{stacked:!0,barPercentage:.5,gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};$wrapper.outerWidth()>=400&&(e.options.aspectRatio=2.1),$wrapper.outerWidth()>=600&&(e.options.aspectRatio=2.3),gData.demography_women.forEach(function(t,a){e.data.labels.push(LABELS[LANG].age[a]);for(let a=0;a<3;a++)e.data.datasets[a].data.push(t[a])});let a=$canvas.getContext("2d");window.myChart=new Chart(a,e)})(),n(""),i("1"),$(".updated-last").text(gData.updated.last[LANG]),$(".updated-demography-sum").text(gData.updated.demography[LANG]),$(".updated-demography-men").text(gData.updated.demography[LANG]),$(".updated-demography-women").text(gData.updated.demography[LANG]),a(),$("#cover-block").fadeOut()}),$(".transition").find(".switch").on("click",function(){let t=$(this).closest(".transition");$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),r(t,t.attr("code"),t.attr("pref"),!0)}),$("#select-prefecture").on("change",function(){let t=$(this).val();i(t)}),$("#select-pref-type").on("change",function(){n("")}),$(".more").on("click",function(){$(this).closest("p.notes").addClass("show")}),$(".checkboxes").find(".checkbox").on("click",function(){$(this).hasClass("on")?$(this).removeClass("on"):$(this).addClass("on");let t=$(this).closest(".transition");r(t,t.attr("code"),t.attr("pref"),!1)}),$('a[href^="#"]').click(function(){let t=$(this).attr("href"),e=$(t).offset().top;return $("body,html").animate({scrollTop:e},400,"swing"),!1})};$(function(){init()});